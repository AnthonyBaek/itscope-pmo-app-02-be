# 에러/예외 응답 정책 (Error Response Policy)

## 개요
이 문서는 PMO 애플리케이션의 모든 에러 및 예외 상황에 대한 응답 정책을 표 형식으로 체계적으로 정리합니다.  
표준화된 에러 응답 형식, HTTP 상태코드, 로깅 정책을 포함합니다.

---

## 표준 에러 응답 형식

### ErrorResponse DTO

| 항목 | 상세 내용 |
|------|-----------|
| **클래스명** | `ErrorResponse` |
| **용도** | 모든 에러 상황의 표준 응답 |
| **Content-Type** | `application/json` |
| **패키지** | `com.itscope.pmo.dto.common.response` |

#### 필드 명세

| 필드명 | 타입 | 필수여부 | 설명 | 형식 | 예시 값 |
|--------|------|----------|------|------|---------|
| `message` | String | Yes | 사용자 친화적 에러 메시지 | 한글 메시지 | `이메일 또는 비밀번호가 일치하지 않습니다.` |
| `timestamp` | String | Yes | 에러 발생 시간 | ISO 8601 | `2024-01-15T10:30:00Z` |

#### JSON 응답 형식

```json
{
  "message": "에러 메시지",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

---

## HTTP 상태코드별 에러 정의

### 4xx 클라이언트 에러

| 상태코드 | 상태명 | 발생 상황 | 메시지 예시 | 원인 | 해결방안 |
|----------|--------|-----------|-------------|------|-----------|
| **400** | Bad Request | 요청 데이터 검증 실패 | `이메일은 필수 입력값입니다.` | 필수 필드 누락 | 필드값 확인 후 재요청 |
| **400** | Bad Request | 요청 형식 오류 | `이메일 형식이 올바르지 않습니다.` | 잘못된 이메일 형식 | 올바른 형식으로 수정 |
| **400** | Bad Request | JSON 파싱 오류 | `요청 데이터 형식이 올바르지 않습니다.` | 잘못된 JSON | JSON 형식 확인 |
| **400** | Bad Request | JWT 토큰 형식 오류 | `토큰 형식이 올바르지 않습니다.` | Bearer 스키마 오류 | "Bearer {token}" 형식 확인 |
| **401** | Unauthorized | 인증 실패 | `이메일 또는 비밀번호가 일치하지 않습니다.` | 잘못된 로그인 정보 | 로그인 정보 확인 |
| **401** | Unauthorized | 토큰 누락 | `토큰이 제공되지 않았습니다.` | Authorization 헤더 누락 | 토큰 포함하여 재요청 |
| **401** | Unauthorized | 토큰 만료 | `토큰이 만료되었습니다.` | JWT 토큰 만료 | 재로그인 필요 |
| **401** | Unauthorized | 토큰 서명 오류 | `유효하지 않은 토큰입니다.` | JWT 서명 불일치 | 새로운 토큰 발급 |
| **401** | Unauthorized | 사용자 없음 | `사용자를 찾을 수 없습니다.` | 토큰의 사용자 정보 불일치 | 토큰 재발급 |
| **403** | Forbidden | 권한 부족 | `해당 작업을 수행할 권한이 없습니다.` | 권한 부족 | 권한 요청 또는 관리자 문의 |
| **404** | Not Found | 리소스 없음 | `요청한 페이지를 찾을 수 없습니다.` | 잘못된 URL | URL 확인 |
| **409** | Conflict | 데이터 충돌 | `이미 존재하는 이메일입니다.` | 중복 데이터 | 다른 값으로 시도 |
| **422** | Unprocessable Entity | 비즈니스 로직 오류 | `비밀번호는 최소 8자 이상이어야 합니다.` | 비즈니스 규칙 위반 | 규칙에 맞게 수정 |
| **429** | Too Many Requests | 요청 과다 | `너무 많은 요청이 발생했습니다. 잠시 후 다시 시도해주세요.` | Rate Limit 초과 | 잠시 후 재시도 |

### 5xx 서버 에러

| 상태코드 | 상태명 | 발생 상황 | 메시지 예시 | 원인 | 해결방안 |
|----------|--------|-----------|-------------|------|-----------|
| **500** | Internal Server Error | 일반 서버 오류 | `서버에 일시적인 오류가 발생했습니다.` | 예상치 못한 서버 오류 | 개발팀 문의 |
| **500** | Internal Server Error | 데이터베이스 오류 | `서버에 일시적인 오류가 발생했습니다.` | DB 연결 실패 | 개발팀 문의 |
| **500** | Internal Server Error | 외부 API 오류 | `서버에 일시적인 오류가 발생했습니다.` | 외부 서비스 장애 | 개발팀 문의 |
| **503** | Service Unavailable | 서비스 중단 | `현재 서비스를 이용할 수 없습니다.` | 점검 또는 장애 | 공지사항 확인 |

---

## API별 에러 시나리오

### POST /api/auth/login

| 시나리오 | HTTP 상태 | 에러 메시지 | 발생 조건 | 응답 예시 |
|----------|-----------|-------------|-----------|-----------|
| **이메일 누락** | 400 | `이메일은 필수 입력값입니다.` | email 필드 없음 | `{"message": "이메일은 필수 입력값입니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **이메일 형식 오류** | 400 | `올바른 이메일 형식이 아닙니다.` | 잘못된 이메일 형식 | `{"message": "올바른 이메일 형식이 아닙니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **비밀번호 누락** | 400 | `비밀번호는 필수 입력값입니다.` | password 필드 없음 | `{"message": "비밀번호는 필수 입력값입니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **비밀번호 길이 부족** | 400 | `비밀번호는 최소 8자 이상이어야 합니다.` | 8자 미만 비밀번호 | `{"message": "비밀번호는 최소 8자 이상이어야 합니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **로그인 실패** | 401 | `이메일 또는 비밀번호가 일치하지 않습니다.` | 인증 실패 | `{"message": "이메일 또는 비밀번호가 일치하지 않습니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **계정 비활성화** | 401 | `비활성화된 계정입니다.` | 계정 상태 INACTIVE | `{"message": "비활성화된 계정입니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **서버 오류** | 500 | `서버에 일시적인 오류가 발생했습니다.` | 예상치 못한 오류 | `{"message": "서버에 일시적인 오류가 발생했습니다.", "timestamp": "2024-01-15T10:30:00Z"}` |

### GET /api/main

| 시나리오 | HTTP 상태 | 에러 메시지 | 발생 조건 | 응답 예시 |
|----------|-----------|-------------|-----------|-----------|
| **토큰 누락** | 401 | `토큰이 제공되지 않았습니다.` | Authorization 헤더 없음 | `{"message": "토큰이 제공되지 않았습니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **토큰 형식 오류** | 400 | `토큰 형식이 올바르지 않습니다.` | Bearer 스키마 오류 | `{"message": "토큰 형식이 올바르지 않습니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **토큰 만료** | 401 | `토큰이 만료되었습니다.` | JWT 만료 | `{"message": "토큰이 만료되었습니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **토큰 서명 오류** | 401 | `유효하지 않은 토큰입니다.` | JWT 서명 불일치 | `{"message": "유효하지 않은 토큰입니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **사용자 없음** | 401 | `사용자를 찾을 수 없습니다.` | 토큰의 사용자 불일치 | `{"message": "사용자를 찾을 수 없습니다.", "timestamp": "2024-01-15T10:30:00Z"}` |
| **서버 오류** | 500 | `서버에 일시적인 오류가 발생했습니다.` | 예상치 못한 오류 | `{"message": "서버에 일시적인 오류가 발생했습니다.", "timestamp": "2024-01-15T10:30:00Z"}` |

---

## 검증 에러 상세 정의

### Bean Validation 에러

| 검증 어노테이션 | 에러 메시지 | 적용 필드 | 상태코드 | 예시 상황 |
|-----------------|-------------|-----------|----------|-----------|
| `@NotBlank` | `{필드명}은 필수 입력값입니다.` | email, password | 400 | 빈 문자열 입력 |
| `@Email` | `올바른 이메일 형식이 아닙니다.` | email | 400 | "invalid-email" 입력 |
| `@Size(min=8)` | `비밀번호는 최소 8자 이상이어야 합니다.` | password | 400 | "123" 입력 |
| `@Size(max=100)` | `비밀번호는 100자 이하여야 합니다.` | password | 400 | 101자 이상 입력 |
| `@NotNull` | `{필드명}은 필수 입력값입니다.` | 모든 필수 필드 | 400 | null 값 입력 |

### 커스텀 검증 에러 (향후 확장)

| 검증 규칙 | 에러 메시지 | 적용 상황 | 상태코드 | Phase |
|-----------|-------------|-----------|----------|-------|
| 비밀번호 복잡도 | `비밀번호는 영문, 숫자, 특수문자를 포함해야 합니다.` | 약한 비밀번호 | 422 | Phase 2 |
| 이메일 도메인 제한 | `허용되지 않은 이메일 도메인입니다.` | 외부 이메일 | 422 | Phase 2 |
| 중복 이메일 | `이미 존재하는 이메일입니다.` | 회원가입 시 | 409 | Phase 2 |

---

## 에러 로깅 정책

### 로그 레벨별 분류

| 로그 레벨 | 사용 상황 | 로깅 대상 | 예시 메시지 | 로그 위치 |
|-----------|-----------|-----------|-------------|-----------|
| **ERROR** | 서버 내부 오류 | 500 에러, 예외 스택 | `[ERROR] JWT token validation failed: Invalid signature` | 에러 로그 파일 |
| **WARN** | 의심스러운 활동 | 반복 로그인 실패, 권한 부족 | `[WARN] Multiple login failures for email: test@***` | 보안 로그 파일 |
| **INFO** | 정상적인 비즈니스 로직 | 로그인 성공, API 호출 | `[INFO] User logged in successfully: test@***` | 애플리케이션 로그 |
| **DEBUG** | 개발/디버깅 정보 | 요청/응답 데이터 | `[DEBUG] Login request received for email: test@***` | 디버그 로그 (개발환경만) |

### 보안 정보 마스킹 규칙

| 정보 유형 | 마스킹 규칙 | 원본 예시 | 마스킹 결과 | 적용 위치 |
|-----------|-------------|-----------|-------------|-----------|
| **이메일** | 앞 2자리 + *** + 도메인 | `test@example.com` | `te***@example.com` | 모든 로그 |
| **비밀번호** | 완전 마스킹 | `password123` | `***` | 모든 로그 |
| **JWT 토큰** | 앞뒤 6자리만 표시 | `eyJhbGci...signature` | `eyJhbG***nature` | 에러 로그 |
| **사용자 ID** | 중간 자리 마스킹 | `12345` | `1***5` | 보안 로그 |
| **IP 주소** | 마지막 옥텟 마스킹 | `192.168.1.100` | `192.168.1.***` | 접속 로그 |

### 로깅 제외 대상

| 제외 정보 | 이유 | 대안 |
|-----------|------|------|
| **전체 비밀번호** | 보안 위험 | 길이만 로깅 |
| **완전한 JWT 토큰** | 토큰 탈취 위험 | 일부만 마스킹 |
| **개인정보** | GDPR/개인정보보호법 | 해시값 또는 ID만 |
| **결제 정보** | PCI DSS 준수 | 마스킹된 카드번호 |

---

## 에러 처리 플로우

### 에러 발생 시 처리 순서

| 단계 | 처리 내용 | 담당 컴포넌트 | 소요시간 |
|------|-----------|----------------|----------|
| **1. 에러 감지** | 예외 발생 또는 검증 실패 | Controller, Service | ~1ms |
| **2. 에러 분류** | HTTP 상태코드 결정 | ExceptionHandler | ~1ms |
| **3. 메시지 생성** | 사용자 친화적 메시지 생성 | MessageResolver | ~2ms |
| **4. 로깅 처리** | 보안 마스킹 후 로그 기록 | LoggingAspect | ~5ms |
| **5. 응답 생성** | ErrorResponse DTO 생성 | ExceptionHandler | ~1ms |
| **6. 응답 반환** | 클라이언트에 JSON 응답 | Spring MVC | ~1ms |

### Spring Boot 예외 처리 구조

| 컴포넌트 | 역할 | 처리 에러 유형 | 어노테이션 |
|----------|------|----------------|------------|
| `@ControllerAdvice` | 전역 예외 처리 | 모든 예외 | `@ExceptionHandler` |
| `@Valid` | 요청 검증 | Bean Validation 에러 | `@Valid` |
| `AuthenticationEntryPoint` | 인증 실패 처리 | JWT 관련 에러 | Spring Security |
| `AccessDeniedHandler` | 권한 부족 처리 | 권한 관련 에러 | Spring Security |

---

## 모니터링 및 알림

### 에러 모니터링 지표

| 지표명 | 설명 | 임계값 | 알림 조건 | 대응 방안 |
|--------|------|--------|-----------|-----------|
| **4xx 에러율** | 클라이언트 에러 비율 | 10% | 5분간 임계값 초과 | 클라이언트 문의 안내 |
| **5xx 에러율** | 서버 에러 비율 | 1% | 1분간 임계값 초과 | 긴급 대응 |
| **로그인 실패율** | 로그인 실패 비율 | 20% | 5분간 임계값 초과 | 보안팀 알림 |
| **토큰 만료율** | 토큰 만료 에러 비율 | 15% | 10분간 임계값 초과 | 토큰 만료시간 검토 |

### 에러 알림 정책

| 에러 유형 | 알림 대상 | 알림 방법 | 응답 시간 |
|-----------|-----------|-----------|-----------|
| **서버 에러 (5xx)** | 개발팀, 운영팀 | Slack, 이메일 | 즉시 |
| **보안 에러** | 보안팀, 개발팀 | Slack, SMS | 5분 이내 |
| **비즈니스 에러** | 개발팀 | Slack | 30분 이내 |
| **성능 저하** | 운영팀 | 모니터링 대시보드 | 1시간 이내 |

---

## 향후 확장 계획

### Phase 2 확장 기능

| 기능 | 설명 | 우선순위 | 구현 방식 |
|------|------|----------|-----------|
| **에러 코드 체계** | 고유 에러 코드 부여 | 높음 | `ERR_AUTH_001` 형식 |
| **다국어 에러 메시지** | 언어별 에러 메시지 | 중간 | MessageSource 활용 |
| **에러 상세 정보** | 개발자용 상세 정보 | 중간 | 개발/운영 환경 분리 |
| **에러 트래킹** | 에러 발생 추적 | 낮음 | Sentry, Bugsnag 연동 |

### 성능 최적화

| 항목 | 현재 상태 | 목표 | 개선 방안 |
|------|-----------|------|-----------|
| **에러 응답 시간** | ~10ms | ~5ms | 메시지 캐싱 |
| **로그 처리 시간** | ~5ms | ~2ms | 비동기 로깅 |
| **메모리 사용량** | 높음 | 낮음 | 로그 로테이션 |

---

## 관련 문서
- [상세 DTO 명세](./detailed_dtos.md)
- [JWT 토큰 상세 명세](./detailed_jwt_token.md)
- [API 엔드포인트 명세](../../01_architecture/02_da/api_endpoints.md)
- [사용자 로그인 플로우](../01_user_flow/flow_001_signin.md) 